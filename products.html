<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>도서 목록 | MY LIBRARY</title>
  
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2232/2232688.png">
  
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 50px 0;
    }
    .page-btn {
      padding: 10px 15px;
      border: 1px solid #ddd;
      background: white;
      color: #333;
      cursor: pointer;
      border-radius: 4px;
      font-weight: bold;
      transition: all 0.2s;
    }
    .page-btn:hover {
      background: #f1f1f1;
      border-color: #bbb;
    }
    .page-btn.active {
      background: #2c3e50; /* 메인 테마색 */
      color: white;
      border-color: #2c3e50;
    }
    .page-btn:disabled {
      color: #ccc;
      cursor: not-allowed;
      border-color: #eee;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <div class="top-right">
      <a href="#">회원가입</a><span>|</span><a href="#">로그인</a><span>|</span><a href="#">장바구니</a>
    </div>
  </div>

  <header>
    <a href="/" style="text-decoration:none; color:inherit;">
      <div class="logo">MY LIBRARY</div>
    </a>
    <nav>
      <ul>
        <li><a href="products.html?query=베스트셀러">베스트셀러</a></li>
        <li><a href="products.html?query=소설">소설</a></li>
        <li><a href="products.html?query=인문">인문/사회</a></li>
        <li><a href="products.html?query=IT">IT/과학</a></li>
        <li><a href="products.html?query=경제">경제/경영</a></li>
        <li><a href="products.html?query=자기계발">자기계발</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="product-list">
      <h2 id="category-title">도서 목록</h2>
      <p style="text-align: center; color: #666; margin-bottom: 30px;">
        MY LIBRARY가 엄선한 추천 도서입니다.
      </p>

      <div id="product-container">
        <p id="loading-message" style="text-align:center; width:100%; color:#888; margin: 50px 0;">
          <i class="fas fa-spinner fa-spin"></i> 도서를 불러오는 중입니다...
        </p>
      </div>

      <div class="pagination" id="pagination">
        </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 MY LIBRARY (SONG DONG IN). All rights reserved.</p>
  </footer>

  <div id="book-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div class="modal-body">
        <img id="modal-image" src="" alt="책 표지">
        <div class="modal-text">
          <h3 id="modal-title">책 제목</h3>
          <p id="modal-author" class="meta">저자 | 출판사</p>
          <p id="modal-price" class="price">₩0</p>
          <div class="divider"></div>
          <p id="modal-description">상세 설명...</p>
          <a id="modal-link" href="#" target="_blank" class="btn-link">네이버 상세페이지 이동</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentBooks = [];  // 모달용 데이터
    let currentQuery = '신간'; // 현재 검색어
    let currentPage = 1;    // 현재 페이지
    const itemsPerPage = 12; // 한 페이지당 보여줄 책 개수

    document.addEventListener('DOMContentLoaded', () => {
      // 1. URL에서 검색어 가져오기 (?query=IT)
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get('query');

      if (query) {
        currentQuery = query;
        document.getElementById('category-title').innerText = `'${query}' 관련 도서`;
      } else {
        document.getElementById('category-title').innerText = '전체 도서 목록';
      }

      // 2. 첫 페이지 불러오기
      fetchBooks(currentQuery, 1);
    });

    // 책 데이터 불러오기 함수 (페이징 지원)
    function fetchBooks(query, page) {
      const container = document.getElementById('product-container');
      const loadingMsg = document.getElementById('loading-message');
      
      // 네이버 API의 'start' 파라미터 계산 (1, 13, 25...)
      const start = (page - 1) * itemsPerPage + 1;

      // 스크롤을 맨 위로 올림 (UX)
      window.scrollTo(0, 0);
      
      container.innerHTML = '';
      if(loadingMsg) loadingMsg.style.display = 'block';

      // 서버에 page 정보(start)도 같이 보냄
      fetch(`/api/search/naver-books?query=${query}&start=${start}`)
        .then(res => res.json())
        .then(data => {
          if(loadingMsg) loadingMsg.style.display = 'none';

          const books = data.items;
          const total = data.total; // 전체 검색 결과 수 (네이버가 줌)
          currentBooks = books;

          if (!books || books.length === 0) {
            container.innerHTML = '<p style="text-align:center; width:100%;">검색 결과가 없습니다.</p>';
            document.getElementById('pagination').innerHTML = ''; // 페이징 숨김
            return;
          }

          // 책 카드 생성
          books.forEach((book, index) => {
            const bookCard = document.createElement('div');
            bookCard.className = 'product-card'; // CSS 재사용

            const cleanTitle = book.title.replace(/<[^>]*>/g, "");
            const formattedPrice = parseInt(book.price).toLocaleString();

            bookCard.innerHTML = `
              <div class="img-wrapper">
                <img src="${book.image}" alt="${cleanTitle}" class="product-image">
              </div>
              <h3 class="product-title">${cleanTitle}</h3>
              <p class="product-price">₩${formattedPrice}</p>
              <button class="btn-cart" onclick="openModal(${index})">상세보기</button>
            `;
            container.appendChild(bookCard);
          });

          // 페이징 버튼 만들기
          renderPagination(total, page);
        })
        .catch(err => {
          console.error(err);
          if(loadingMsg) loadingMsg.innerHTML = '<p style="color:red; text-align:center;">서버 연결 실패</p>';
        });
    }

    // 페이징 버튼 그리기 함수 (핵심!)
    function renderPagination(totalItems, page) {
      const paginationEl = document.getElementById('pagination');
      paginationEl.innerHTML = '';

      // 네이버 API는 최대 1000개까지만 검색 결과를 줍니다.
      const maxItems = Math.min(totalItems, 1000); 
      const totalPages = Math.ceil(maxItems / itemsPerPage);
      
      // 너무 많은 페이지가 나오지 않게 현재 페이지 주변만 보여주기 (예: 5개씩)
      const pageGroup = Math.ceil(page / 5);
      let lastPage = pageGroup * 5;
      if (lastPage > totalPages) lastPage = totalPages;
      let firstPage = lastPage - 4;
      if (firstPage < 1) firstPage = 1;

      // [이전] 버튼
      if (firstPage > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.innerText = '<';
        prevBtn.onclick = () => fetchBooks(currentQuery, firstPage - 1);
        paginationEl.appendChild(prevBtn);
      }

      // [번호] 버튼들
      for (let i = firstPage; i <= lastPage; i++) {
        const btn = document.createElement('button');
        btn.className = 'page-btn';
        if (i === page) btn.classList.add('active'); // 현재 페이지 강조
        btn.innerText = i;
        btn.onclick = () => {
          currentPage = i;
          fetchBooks(currentQuery, i);
        };
        paginationEl.appendChild(btn);
      }

      // [다음] 버튼
      if (lastPage < totalPages) {
        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.innerText = '>';
        nextBtn.onclick = () => fetchBooks(currentQuery, lastPage + 1);
        paginationEl.appendChild(nextBtn);
      }
    }

    /* 모달 관련 함수 (메인과 동일) */
    function openModal(index) {
      const book = currentBooks[index];
      if (!book) return;
      document.getElementById('modal-image').src = book.image;
      document.getElementById('modal-title').innerText = book.title.replace(/<[^>]*>/g, "");
      document.getElementById('modal-author').innerText = `${book.author} | ${book.publisher}`;
      document.getElementById('modal-price').innerText = `₩${parseInt(book.price).toLocaleString()}`;
      document.getElementById('modal-description').innerText = book.description ? book.description.replace(/<[^>]*>/g, "") : "내용 없음";
      document.getElementById('modal-link').href = book.link;
      document.getElementById('book-modal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('book-modal').classList.add('hidden'); }
    window.onclick = function(e) { if(e.target == document.getElementById('book-modal')) closeModal(); }
  </script>
</body>
</html>