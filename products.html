<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>도서 목록 | MY LIBRARY</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2232/2232688.png">
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    .pagination { display: flex; justify-content: center; gap: 8px; margin: 50px 0; }
    .page-btn { padding: 10px 15px; border: 1px solid #ddd; background: white; color: #333; cursor: pointer; border-radius: 4px; font-weight: bold; transition: all 0.2s; }
    .page-btn:hover { background: #f1f1f1; border-color: #bbb; }
    .page-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; }
  </style>
</head>
<body>

  <div class="top-bar">
    <div class="top-right">
      <a href="#">회원가입</a><span>|</span><a href="#">로그인</a><span>|</span><a href="#">장바구니</a>
    </div>
  </div>

  <header>
    <a href="/" style="text-decoration:none; color:inherit;">
      <div class="logo">MY LIBRARY</div>
    </a>

    <div class="header-search">
      <input type="text" id="header-search-input" placeholder="도서 검색...">
      <button onclick="headerSearch()" class="header-search-btn">
        <i class="fas fa-search"></i>
      </button>
    </div>
    <nav>
      <ul>
        <li><a href="products.html?query=베스트셀러">베스트셀러</a></li>
        <li><a href="products.html?query=소설">소설</a></li>
        <li><a href="products.html?query=인문">인문/사회</a></li>
        <li><a href="products.html?query=IT">IT/과학</a></li>
        <li><a href="products.html?query=경제">경제/경영</a></li>
        <li><a href="products.html?query=자기계발">자기계발</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="product-list">
      <h2 id="category-title">도서 목록</h2>
      <p style="text-align: center; color: #666; margin-bottom: 30px;">
        MY LIBRARY가 엄선한 추천 도서입니다.
      </p>

      <div id="product-container">
        <p id="loading-message" style="text-align:center; width:100%; color:#888; margin: 50px 0;">
          <i class="fas fa-spinner fa-spin"></i> 도서를 불러오는 중입니다...
        </p>
      </div>

      <div class="pagination" id="pagination"></div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 MY LIBRARY (SONG DONG IN). All rights reserved.</p>
  </footer>

  <div id="book-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div class="modal-body">
        <img id="modal-image" src="" alt="책 표지">
        <div class="modal-text">
          <h3 id="modal-title">책 제목</h3>
          <p id="modal-author" class="meta">저자 | 출판사</p>
          <p id="modal-price" class="price">₩0</p>
          <div class="divider"></div>
          <p id="modal-description">상세 설명...</p>
          <a id="modal-link" href="#" target="_blank" class="btn-link">네이버 상세페이지 이동</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentBooks = [];
    let currentQuery = '신간';
    let currentPage = 1;
    const itemsPerPage = 12; // 한 페이지당 12개 (서버.js 수정 필요)

    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get('query');

      if (query) {
        currentQuery = query;
        document.getElementById('category-title').innerText = `'${query}' 관련 도서`;
      } else {
        document.getElementById('category-title').innerText = '전체 도서 목록';
      }
      fetchBooks(currentQuery, 1);

      // [추가] 헤더 검색창 엔터키 이벤트
      document.getElementById('header-search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') headerSearch();
      });
    });

    // [추가] 헤더 검색 함수
    function headerSearch() {
      const keyword = document.getElementById('header-search-input').value;
      if (!keyword.trim()) {
        alert('검색어를 입력하세요');
        return;
      }
      // 검색 결과 페이지로 이동 (새로고침)
      window.location.href = `products.html?query=${keyword}`;
    }

    function fetchBooks(query, page) {
      const container = document.getElementById('product-container');
      const loadingMsg = document.getElementById('loading-message');
      
      const start = (page - 1) * itemsPerPage + 1;
      window.scrollTo(0, 0);
      
      container.innerHTML = '';
      if(loadingMsg) loadingMsg.style.display = 'block';

      // display=12 파라미터 추가
      fetch(`/api/search/naver-books?query=${query}&start=${start}&display=${itemsPerPage}`)
        .then(res => res.json())
        .then(data => {
          if(loadingMsg) loadingMsg.style.display = 'none';

          const books = data.items;
          const total = data.total;
          currentBooks = books;

          if (!books || books.length === 0) {
            container.innerHTML = '<p style="text-align:center; width:100%;">검색 결과가 없습니다.</p>';
            document.getElementById('pagination').innerHTML = '';
            return;
          }

          books.forEach((book, index) => {
            const bookCard = document.createElement('div');
            bookCard.className = 'product-card';

            const cleanTitle = book.title.replace(/<[^>]*>/g, "");
            const formattedPrice = parseInt(book.price).toLocaleString();

            bookCard.innerHTML = `
              <div class="img-wrapper">
                <img src="${book.image}" alt="${cleanTitle}" class="product-image">
              </div>
              <h3 class="product-title">${cleanTitle}</h3>
              <p class="product-price">₩${formattedPrice}</p>
              <button class="btn-cart" onclick="openModal(${index})">상세보기</button>
            `;
            container.appendChild(bookCard);
          });
          renderPagination(total, page);
        })
        .catch(err => {
          console.error(err);
          if(loadingMsg) loadingMsg.innerHTML = '<p style="color:red; text-align:center;">서버 연결 실패</p>';
        });
    }

    function renderPagination(totalItems, page) {
      const paginationEl = document.getElementById('pagination');
      paginationEl.innerHTML = '';

      const maxItems = Math.min(totalItems, 1000); 
      const totalPages = Math.ceil(maxItems / itemsPerPage);
      const pageGroup = Math.ceil(page / 5);
      let lastPage = pageGroup * 5;
      if (lastPage > totalPages) lastPage = totalPages;
      let firstPage = lastPage - 4;
      if (firstPage < 1) firstPage = 1;

      if (firstPage > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.innerText = '<';
        prevBtn.onclick = () => fetchBooks(currentQuery, firstPage - 1);
        paginationEl.appendChild(prevBtn);
      }

      for (let i = firstPage; i <= lastPage; i++) {
        const btn = document.createElement('button');
        btn.className = 'page-btn';
        if (i === page) btn.classList.add('active');
        btn.innerText = i;
        btn.onclick = () => {
          currentPage = i;
          fetchBooks(currentQuery, i);
        };
        paginationEl.appendChild(btn);
      }

      if (lastPage < totalPages) {
        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.innerText = '>';
        nextBtn.onclick = () => fetchBooks(currentQuery, lastPage + 1);
        paginationEl.appendChild(nextBtn);
      }
    }

    function openModal(index) {
      const book = currentBooks[index];
      if (!book) return;
      document.getElementById('modal-image').src = book.image;
      document.getElementById('modal-title').innerText = book.title.replace(/<[^>]*>/g, "");
      document.getElementById('modal-author').innerText = `${book.author} | ${book.publisher}`;
      document.getElementById('modal-price').innerText = `₩${parseInt(book.price).toLocaleString()}`;
      document.getElementById('modal-description').innerText = book.description ? book.description.replace(/<[^>]*>/g, "") : "내용 없음";
      document.getElementById('modal-link').href = book.link;
      document.getElementById('book-modal').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('book-modal').classList.add('hidden'); }
    window.onclick = function(e) { if(e.target == document.getElementById('book-modal')) closeModal(); }
  </script>
</body>
</html>